name: Prod Deploy (Containerized)

on:
  workflow_dispatch: # ìˆ˜ë™ ë°°í¬ (ë§ˆì´ê·¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸ìš©)
  # TODO: ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ í›„ push íŠ¸ë¦¬ê±° í™œì„±í™”, ci-cd.yamlì˜ deploy-prod job ì œê±°
  # push:
  #   branches:
  #     - main
  #   paths-ignore:
  #     - '.github/**'
  #     - '*.md'
  #     - 'docs/**'

env:
  AWS_REGION: ap-northeast-2

concurrency:
  group: prod-deploy
  cancel-in-progress: false

jobs:
  # â”€â”€â”€ CI: Gradle ë¹Œë“œ ê²€ì¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "gradle"

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build (compile check)
        run: ./gradlew build -x test --no-daemon

      - name: Notify Discord on CI failure
        if: failure()
        run: |
          SHORT_SHA="${GITHUB_SHA:0:7}"
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          ACTIONS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -sS -H "Content-Type: application/json" -X POST -d "{
            \"content\": \"âŒ **[Prod] Backend CI ë¹Œë“œ ì‹¤íŒ¨**\",
            \"embeds\": [{
              \"title\": \"ğŸ”´ ë¹Œë“œ ì‹¤íŒ¨ ì•Œë¦¼\",
              \"color\": 15158528,
              \"fields\": [
                {\"name\": \"ğŸ“¦ ì €ì¥ì†Œ\", \"value\": \"\`${{ github.repository }}\`\", \"inline\": true},
                {\"name\": \"ğŸŒ¿ ë¸Œëœì¹˜\", \"value\": \"\`main\`\", \"inline\": true},
                {\"name\": \"ğŸ”– ì»¤ë°‹\", \"value\": \"[\`${SHORT_SHA}\`](${COMMIT_URL})\", \"inline\": true},
                {\"name\": \"ğŸ“‹ ìƒì„¸ ë¡œê·¸\", \"value\": \"[Actionsì—ì„œ í™•ì¸](${ACTIONS_URL})\", \"inline\": true}
              ],
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
            }]
          }" ${{ secrets.DISCORD_WEBHOOK_URL }} || true

  # â”€â”€â”€ Docker ë¹Œë“œ â†’ ECR Push â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-push:
    needs: ci
    runs-on: ubuntu-24.04-arm
    permissions:
      id-token: write
      contents: read
    outputs:
      image-tag: ${{ steps.meta.outputs.image-tag }}
      api-image: ${{ steps.meta.outputs.api-image }}
      chat-image: ${{ steps.meta.outputs.chat-image }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image metadata
        id: meta
        run: |
          REGISTRY="${{ secrets.ECR_REGISTRY }}"
          SHORT_SHA="${GITHUB_SHA:0:7}"
          TAG="sha-${SHORT_SHA}"

          echo "image-tag=${TAG}" >> $GITHUB_OUTPUT
          echo "api-image=${REGISTRY}/doktori/backend-api" >> $GITHUB_OUTPUT
          echo "chat-image=${REGISTRY}/doktori/backend-chat" >> $GITHUB_OUTPUT

          {
            echo "api-tags<<EOF"
            echo "${REGISTRY}/doktori/backend-api:${TAG}"
            echo "${REGISTRY}/doktori/backend-api:latest"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "chat-tags<<EOF"
            echo "${REGISTRY}/doktori/backend-chat:${TAG}"
            echo "${REGISTRY}/doktori/backend-chat:latest"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push API image
        uses: docker/build-push-action@v6
        with:
          context: .
          target: api
          platforms: linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.api-tags }}
          cache-from: type=gha,scope=prod-api
          cache-to: type=gha,mode=max,scope=prod-api

      - name: Build and push Chat image
        uses: docker/build-push-action@v6
        with:
          context: .
          target: chat
          platforms: linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.chat-tags }}
          cache-from: |
            type=gha,scope=prod-chat
            type=gha,scope=prod-api
          cache-to: type=gha,mode=max,scope=prod-chat

  # â”€â”€â”€ Prod ë°°í¬: SSMìœ¼ë¡œ ê° ì¸ìŠ¤í„´ìŠ¤ì— ì»¨í…Œì´ë„ˆ ë°°í¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy API server via SSM
        id: deploy-api
        run: |
          REGISTRY="${{ secrets.ECR_REGISTRY }}"
          TAG="${{ needs.build-and-push.outputs.image-tag }}"

          API_CMDS=$(jq -n --arg r "$REGISTRY" --arg t "$TAG" '[
            "set -e",
            ("aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin " + $r),
            ("docker pull " + $r + "/doktori/backend-api:" + $t),
            "mkdir -p /home/ubuntu/app/secrets",
            "aws ssm get-parameter --name /doktori/prod/FIREBASE_SERVICE_ACCOUNT --with-decryption --query Parameter.Value --output text > /home/ubuntu/app/secrets/firebase-service-account.json",
            "docker stop doktori-api 2>/dev/null || true",
            "docker rm doktori-api 2>/dev/null || true",
            ("docker run -d --name doktori-api --restart unless-stopped -e SPRING_PROFILES_ACTIVE=prod -e FIREBASE_CREDENTIALS_PATH=file:/app/secrets/firebase-service-account.json -v /home/ubuntu/app/secrets/firebase-service-account.json:/app/secrets/firebase-service-account.json:ro -p 8080:8080 " + $r + "/doktori/backend-api:" + $t),
            "docker image prune -f"
          ]')

          CMD_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Name,Values=doktori-prod-api" \
            --parameters "{\"commands\": $API_CMDS}" \
            --timeout-seconds 300 \
            --comment "deploy prod api ${{ github.sha }}" \
            --query "Command.CommandId" \
            --output text)

          echo "cmd_id=${CMD_ID}" >> $GITHUB_OUTPUT
          echo "API SSM Command: ${CMD_ID}"

      - name: Deploy Chat server via SSM
        id: deploy-chat
        run: |
          REGISTRY="${{ secrets.ECR_REGISTRY }}"
          TAG="${{ needs.build-and-push.outputs.image-tag }}"

          CHAT_CMDS=$(jq -n --arg r "$REGISTRY" --arg t "$TAG" '[
            "set -e",
            ("aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin " + $r),
            ("docker pull " + $r + "/doktori/backend-chat:" + $t),
            "mkdir -p /home/ubuntu/app/secrets",
            "aws ssm get-parameter --name /doktori/prod/FIREBASE_SERVICE_ACCOUNT --with-decryption --query Parameter.Value --output text > /home/ubuntu/app/secrets/firebase-service-account.json",
            "docker stop doktori-chat 2>/dev/null || true",
            "docker rm doktori-chat 2>/dev/null || true",
            ("docker run -d --name doktori-chat --restart unless-stopped -e SPRING_PROFILES_ACTIVE=prod -e FIREBASE_CREDENTIALS_PATH=file:/app/secrets/firebase-service-account.json -v /home/ubuntu/app/secrets/firebase-service-account.json:/app/secrets/firebase-service-account.json:ro -p 8081:8081 " + $r + "/doktori/backend-chat:" + $t),
            "docker image prune -f"
          ]')

          CMD_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Name,Values=doktori-prod-chat" \
            --parameters "{\"commands\": $CHAT_CMDS}" \
            --timeout-seconds 300 \
            --comment "deploy prod chat ${{ github.sha }}" \
            --query "Command.CommandId" \
            --output text)

          echo "cmd_id=${CMD_ID}" >> $GITHUB_OUTPUT
          echo "Chat SSM Command: ${CMD_ID}"

      - name: Wait for deployments
        run: |
          wait_ssm() {
            local cmd_id=$1 label=$2
            for i in $(seq 1 60); do
              sleep 5
              STATUS=$(aws ssm list-command-invocations \
                --command-id "$cmd_id" \
                --query "CommandInvocations[0].Status" \
                --output text 2>/dev/null || echo "Pending")
              echo "[$label $i/60] $STATUS"
              case "$STATUS" in
                Success) return 0 ;;
                Failed|Cancelled|TimedOut|DeliveryTimedOut)
                  echo "::error::${label} deployment failed: ${STATUS}"
                  aws ssm list-command-invocations --command-id "$cmd_id" --details \
                    --query "CommandInvocations[0].CommandPlugins[0].Output" --output text || true
                  return 1 ;;
              esac
            done
            echo "::error::${label} deployment timed out (300s)"
            return 1
          }

          wait_ssm "${{ steps.deploy-api.outputs.cmd_id }}" "API"
          wait_ssm "${{ steps.deploy-chat.outputs.cmd_id }}" "Chat"

      - name: Notify Discord
        if: always()
        run: |
          SHORT_SHA="${GITHUB_SHA:0:7}"
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -1)
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          ACTIONS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "${{ job.status }}" == "success" ]; then
            COLOR=3066993; STATUS_EMOJI="âœ…"; STATUS_TEXT="ë°°í¬ ì„±ê³µ"
          else
            COLOR=15158528; STATUS_EMOJI="âŒ"; STATUS_TEXT="ë°°í¬ ì‹¤íŒ¨"
          fi

          curl -sS -H "Content-Type: application/json" -X POST -d "{
            \"content\": \"${STATUS_EMOJI} **Backend Production ë°°í¬ ì•Œë¦¼**\",
            \"embeds\": [{
              \"title\": \"ğŸš€ [Production] ${STATUS_TEXT}\",
              \"color\": ${COLOR},
              \"fields\": [
                {\"name\": \"ğŸ“¦ ì €ì¥ì†Œ\", \"value\": \"\`${{ github.repository }}\`\", \"inline\": true},
                {\"name\": \"ğŸŒ¿ ë¸Œëœì¹˜\", \"value\": \"\`main\`\", \"inline\": true},
                {\"name\": \"ğŸ”– ì»¤ë°‹\", \"value\": \"[\`${SHORT_SHA}\`](${COMMIT_URL})\", \"inline\": true},
                {\"name\": \"ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€\", \"value\": \"${COMMIT_MSG}\", \"inline\": false},
                {\"name\": \"ğŸ‘¤ ì‘ì„±ì\", \"value\": \"${COMMIT_AUTHOR}\", \"inline\": true},
                {\"name\": \"ğŸ“‹ ìƒì„¸ ë¡œê·¸\", \"value\": \"[Actionsì—ì„œ í™•ì¸](${ACTIONS_URL})\", \"inline\": true}
              ],
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
            }]
          }" ${{ secrets.DISCORD_WEBHOOK_URL }} || true