name: Backend CI/CD

on:
  workflow_dispatch:
  push:
    branches:
      - develop
      - main
    paths-ignore:
      - '.github/**'
      - '*.md'
      - 'docs/**'
  pull_request:
    branches:
      - develop
      - main

concurrency:
  group: backend-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-source-branch:
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Validate source branch
        run: |
          if [ "${{ github.head_ref }}" != "develop" ] && [[ "${{ github.head_ref }}" != hotfix/* ]]; then
            echo "âŒ Error: Only 'develop' or 'hotfix/*' branches can be merged into 'main'"
            echo "Source branch: ${{ github.head_ref }}"
            exit 1
          fi
          echo "âœ… Source branch validation passed: ${{ github.head_ref }}"

  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "gradle"

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build (includes compile check)
        run: ./gradlew build -x test --no-daemon

      - name: Notify Discord on failure
        if: failure()
        run: |
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -1)
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          ACTIONS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"content\": \"âŒ **Backend CI ë¹Œë“œ ì‹¤íŒ¨**\",
                 \"embeds\": [{
                   \"title\": \"ğŸ”´ ë¹Œë“œ ì‹¤íŒ¨ ì•Œë¦¼\",
                   \"color\": 15158528,
                   \"fields\": [
                     {\"name\": \"ğŸ“¦ ì €ì¥ì†Œ\", \"value\": \"\`${{ github.repository }}\`\", \"inline\": true},
                     {\"name\": \"ğŸŒ¿ ë¸Œëœì¹˜\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true},
                     {\"name\": \"ğŸ”– ì»¤ë°‹\", \"value\": \"[\`$SHORT_SHA\`]($COMMIT_URL)\", \"inline\": true},
                     {\"name\": \"ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€\", \"value\": \"$COMMIT_MSG\", \"inline\": false},
                     {\"name\": \"ğŸ‘¤ ì‘ì„±ì\", \"value\": \"$COMMIT_AUTHOR\", \"inline\": true},
                     {\"name\": \"ğŸ“‹ ìƒì„¸ ë¡œê·¸\", \"value\": \"[Actionsì—ì„œ í™•ì¸]($ACTIONS_URL)\", \"inline\": true}
                   ],
                   \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
                 }]
               }" \
               ${{ secrets.DISCORD_WEBHOOK_URL }} || true

  build-and-push:
    needs: ci
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-24.04-arm
    permissions:
      id-token: write
      contents: read
    outputs:
      image-tag: ${{ steps.meta.outputs.image-tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image metadata
        id: meta
        run: |
          REGISTRY="${{ secrets.ECR_REGISTRY }}"
          if [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            TAG="develop"
            echo "api-tags=${REGISTRY}/doktori/backend-api:develop" >> $GITHUB_OUTPUT
            echo "chat-tags=${REGISTRY}/doktori/backend-chat:develop" >> $GITHUB_OUTPUT
          else
            SHORT_SHA="${GITHUB_SHA:0:7}"
            TAG="sha-${SHORT_SHA}"

            {
              echo "api-tags<<EOF"
              echo "${REGISTRY}/doktori/backend-api:sha-${SHORT_SHA}"
              echo "${REGISTRY}/doktori/backend-api:latest"
              echo "EOF"
            } >> $GITHUB_OUTPUT

            {
              echo "chat-tags<<EOF"
              echo "${REGISTRY}/doktori/backend-chat:sha-${SHORT_SHA}"
              echo "${REGISTRY}/doktori/backend-chat:latest"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          fi
          echo "image-tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push API image
        uses: docker/build-push-action@v6
        with:
          context: .
          target: api
          platforms: linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.api-tags }}
          cache-from: type=gha,scope=api
          cache-to: type=gha,mode=max,scope=api

      - name: Build and push Chat image
        uses: docker/build-push-action@v6
        with:
          context: .
          target: chat
          platforms: linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.chat-tags }}
          cache-from: |
            type=gha,scope=chat
            type=gha,scope=api
          cache-to: type=gha,mode=max,scope=chat

  deploy-dev:
    needs: build-and-push
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ap-northeast-2

      - name: Deploy to Dev via SSM
        run: |
          COMMANDS=$(jq -n --arg registry "${{ secrets.ECR_REGISTRY }}" '[
            "set -e",
            ("export ECR_REGISTRY=" + $registry),
            "docker compose -f /home/ubuntu/app/docker-compose.yml pull backend chat",
            "docker compose -f /home/ubuntu/app/docker-compose.yml up -d --no-deps backend chat",
            "docker image prune -f"
          ]')

          CMD_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Environment,Values=dev" "Key=tag:Service,Values=app" \
            --parameters "{\"commands\": $COMMANDS}" \
            --timeout-seconds 300 \
            --comment "deploy dev ${{ github.sha }}" \
            --query "Command.CommandId" \
            --output text)

          echo "SSM Command: $CMD_ID"

          for i in $(seq 1 60); do
            sleep 5
            STATUS=$(aws ssm list-command-invocations \
              --command-id "$CMD_ID" \
              --query "CommandInvocations[0].Status" \
              --output text 2>/dev/null || echo "Pending")
            echo "[$i/60] $STATUS"
            case "$STATUS" in
              Success) exit 0 ;;
              Failed|Cancelled|TimedOut|DeliveryTimedOut)
                aws ssm list-command-invocations --command-id "$CMD_ID" --details \
                  --query "CommandInvocations[0].CommandPlugins[0].Output" --output text || true
                exit 1 ;;
            esac
          done
          echo "::error::SSM command timed out"
          exit 1

      - name: Notify Discord
        if: always()
        run: |
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -1)
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          ACTIONS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "${{ job.status }}" == "success" ]; then
            COLOR=3066993; STATUS_EMOJI="âœ…"; STATUS_TEXT="ë°°í¬ ì„±ê³µ"
          else
            COLOR=15158528; STATUS_EMOJI="âŒ"; STATUS_TEXT="ë°°í¬ ì‹¤íŒ¨"
          fi

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"content\": \"$STATUS_EMOJI **Backend Development ë°°í¬ ì•Œë¦¼**\",
                 \"embeds\": [{
                   \"title\": \"ğŸ”§ [Development] $STATUS_TEXT\",
                   \"color\": $COLOR,
                   \"fields\": [
                     {\"name\": \"ğŸ“¦ ì €ì¥ì†Œ\", \"value\": \"\`${{ github.repository }}\`\", \"inline\": true},
                     {\"name\": \"ğŸŒ¿ ë¸Œëœì¹˜\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true},
                     {\"name\": \"ğŸ”– ì»¤ë°‹\", \"value\": \"[\`$SHORT_SHA\`]($COMMIT_URL)\", \"inline\": true},
                     {\"name\": \"ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€\", \"value\": \"$COMMIT_MSG\", \"inline\": false},
                     {\"name\": \"ğŸ‘¤ ì‘ì„±ì\", \"value\": \"$COMMIT_AUTHOR\", \"inline\": true},
                     {\"name\": \"ğŸ“‹ ìƒì„¸ ë¡œê·¸\", \"value\": \"[Actionsì—ì„œ í™•ì¸]($ACTIONS_URL)\", \"inline\": true}
                   ],
                   \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
                 }]
               }" \
               ${{ secrets.DISCORD_WEBHOOK_URL }} || true

  deploy-prod:
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ap-northeast-2

      - name: Deploy to Prod via SSM
        run: |
          REGISTRY="${{ secrets.ECR_REGISTRY }}"
          TAG="${{ needs.build-and-push.outputs.image-tag }}"

          wait_ssm() {
            local cmd_id=$1 label=$2
            for i in $(seq 1 60); do
              sleep 5
              STATUS=$(aws ssm list-command-invocations \
                --command-id "$cmd_id" \
                --query "CommandInvocations[0].Status" \
                --output text 2>/dev/null || echo "Pending")
              echo "[$label $i/60] $STATUS"
              case "$STATUS" in
                Success) return 0 ;;
                Failed|Cancelled|TimedOut|DeliveryTimedOut)
                  aws ssm list-command-invocations --command-id "$cmd_id" --details \
                    --query "CommandInvocations[0].CommandPlugins[0].Output" --output text || true
                  return 1 ;;
              esac
            done
            echo "::error::SSM $label timed out"
            return 1
          }

          # Deploy API server
          API_CMDS=$(jq -n --arg r "$REGISTRY" --arg t "$TAG" '[
            "set -e",
            ("aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin " + $r),
            ("docker pull " + $r + "/doktori/backend-api:" + $t),
            "docker stop backend-api 2>/dev/null || true",
            "docker rm backend-api 2>/dev/null || true",
            ("docker run -d --name backend-api --restart unless-stopped --env-file /home/ubuntu/app/.env -p 8080:8080 " + $r + "/doktori/backend-api:" + $t),
            "docker image prune -f"
          ]')

          API_CMD_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Environment,Values=prod" "Key=tag:Service,Values=backend-api" \
            --parameters "{\"commands\": $API_CMDS}" \
            --timeout-seconds 300 \
            --comment "deploy prod api ${{ github.sha }}" \
            --query "Command.CommandId" \
            --output text)

          # Deploy Chat server
          CHAT_CMDS=$(jq -n --arg r "$REGISTRY" --arg t "$TAG" '[
            "set -e",
            ("aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin " + $r),
            ("docker pull " + $r + "/doktori/backend-chat:" + $t),
            "docker stop backend-chat 2>/dev/null || true",
            "docker rm backend-chat 2>/dev/null || true",
            ("docker run -d --name backend-chat --restart unless-stopped --env-file /home/ubuntu/app/.env -p 8081:8081 " + $r + "/doktori/backend-chat:" + $t),
            "docker image prune -f"
          ]')

          CHAT_CMD_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Environment,Values=prod" "Key=tag:Service,Values=backend-chat" \
            --parameters "{\"commands\": $CHAT_CMDS}" \
            --timeout-seconds 300 \
            --comment "deploy prod chat ${{ github.sha }}" \
            --query "Command.CommandId" \
            --output text)

          echo "API CMD: $API_CMD_ID / Chat CMD: $CHAT_CMD_ID"

          # Wait for both (parallel send, sequential wait)
          wait_ssm "$API_CMD_ID" "api"
          wait_ssm "$CHAT_CMD_ID" "chat"

      - name: Notify Discord
        if: always()
        run: |
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -1)
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          ACTIONS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "${{ job.status }}" == "success" ]; then
            COLOR=3066993; STATUS_EMOJI="âœ…"; STATUS_TEXT="ë°°í¬ ì„±ê³µ"
          else
            COLOR=15158528; STATUS_EMOJI="âŒ"; STATUS_TEXT="ë°°í¬ ì‹¤íŒ¨"
          fi

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"content\": \"$STATUS_EMOJI **Backend Production ë°°í¬ ì•Œë¦¼**\",
                 \"embeds\": [{
                   \"title\": \"ğŸš€ [Production] $STATUS_TEXT\",
                   \"color\": $COLOR,
                   \"fields\": [
                     {\"name\": \"ğŸ“¦ ì €ì¥ì†Œ\", \"value\": \"\`${{ github.repository }}\`\", \"inline\": true},
                     {\"name\": \"ğŸŒ¿ ë¸Œëœì¹˜\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true},
                     {\"name\": \"ğŸ”– ì»¤ë°‹\", \"value\": \"[\`$SHORT_SHA\`]($COMMIT_URL)\", \"inline\": true},
                     {\"name\": \"ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€\", \"value\": \"$COMMIT_MSG\", \"inline\": false},
                     {\"name\": \"ğŸ‘¤ ì‘ì„±ì\", \"value\": \"$COMMIT_AUTHOR\", \"inline\": true},
                     {\"name\": \"ğŸ“‹ ìƒì„¸ ë¡œê·¸\", \"value\": \"[Actionsì—ì„œ í™•ì¸]($ACTIONS_URL)\", \"inline\": true}
                   ],
                   \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
                 }]
               }" \
               ${{ secrets.DISCORD_WEBHOOK_URL }} || true
