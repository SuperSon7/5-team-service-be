name: Backend CI/CD

on:
  workflow_dispatch:
  push:
    branches:
      - develop
      - main
    paths-ignore:
      - '.github/**'
      - '*.md'
      - 'docs/**'
  pull_request:
    branches:
      - develop
      - main

concurrency:
  group: backend-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  check-source-branch:
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Validate source branch
        run: |
          if [ "${{ github.head_ref }}" != "develop" ] && [[ "${{ github.head_ref }}" != hotfix/* ]]; then
            echo "âŒ Error: Only 'develop' or 'hotfix/*' branches can be merged into 'main'"
            echo "Source branch: ${{ github.head_ref }}"
            exit 1
          fi
          echo "âœ… Source branch validation passed: ${{ github.head_ref }}"

  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "gradle"

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build (includes compile check)
        run: ./gradlew build -x test --no-daemon

      - name: Notify Discord on failure
        if: failure()
        run: |
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -1)
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          ACTIONS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"content\": \"âŒ **Backend CI ë¹Œë“œ ì‹¤íŒ¨**\",
                 \"embeds\": [{
                   \"title\": \"ğŸ”´ ë¹Œë“œ ì‹¤íŒ¨ ì•Œë¦¼\",
                   \"color\": 15158528,
                   \"fields\": [
                     {\"name\": \"ğŸ“¦ ì €ì¥ì†Œ\", \"value\": \"\`${{ github.repository }}\`\", \"inline\": true},
                     {\"name\": \"ğŸŒ¿ ë¸Œëœì¹˜\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true},
                     {\"name\": \"ğŸ”– ì»¤ë°‹\", \"value\": \"[\`$SHORT_SHA\`]($COMMIT_URL)\", \"inline\": true},
                     {\"name\": \"ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€\", \"value\": \"$COMMIT_MSG\", \"inline\": false},
                     {\"name\": \"ğŸ‘¤ ì‘ì„±ì\", \"value\": \"$COMMIT_AUTHOR\", \"inline\": true},
                     {\"name\": \"ğŸ“‹ ìƒì„¸ ë¡œê·¸\", \"value\": \"[Actionsì—ì„œ í™•ì¸]($ACTIONS_URL)\", \"inline\": true}
                   ],
                   \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
                 }]
               }" \
               ${{ secrets.DISCORD_WEBHOOK_URL }} || true

  build-and-push:
    needs: ci
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-24.04-arm
    permissions:
      id-token: write
      contents: read
    outputs:
      image-tag: ${{ steps.meta.outputs.image-tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image metadata
        id: meta
        run: |
          REGISTRY="${{ secrets.ECR_REGISTRY }}"
          if [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            TAG="develop"
            echo "api-tags=${REGISTRY}/doktori/backend-api:develop" >> $GITHUB_OUTPUT
            echo "chat-tags=${REGISTRY}/doktori/backend-chat:develop" >> $GITHUB_OUTPUT
          else
            SHORT_SHA="${GITHUB_SHA:0:7}"
            TAG="sha-${SHORT_SHA}"

            {
              echo "api-tags<<EOF"
              echo "${REGISTRY}/doktori/backend-api:sha-${SHORT_SHA}"
              echo "${REGISTRY}/doktori/backend-api:latest"
              echo "EOF"
            } >> $GITHUB_OUTPUT

            {
              echo "chat-tags<<EOF"
              echo "${REGISTRY}/doktori/backend-chat:sha-${SHORT_SHA}"
              echo "${REGISTRY}/doktori/backend-chat:latest"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          fi
          echo "image-tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push API image
        uses: docker/build-push-action@v6
        with:
          context: .
          target: api
          platforms: linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.api-tags }}
          cache-from: type=gha,scope=api
          cache-to: type=gha,mode=max,scope=api

      - name: Build and push Chat image
        uses: docker/build-push-action@v6
        with:
          context: .
          target: chat
          platforms: linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.chat-tags }}
          cache-from: |
            type=gha,scope=chat
            type=gha,scope=api
          cache-to: type=gha,mode=max,scope=chat

  deploy-dev:
    needs: build-and-push
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ap-northeast-2

      - name: Deploy to Dev via SSM
        run: |
          COMMANDS=$(jq -n --arg registry "${{ secrets.ECR_REGISTRY }}" '[
            "set -e",
            ("export ECR_REGISTRY=" + $registry),
            "mkdir -p /home/ubuntu/app/secrets",
            "aws ssm get-parameter --name /doktori/dev/FIREBASE_SERVICE_ACCOUNT --with-decryption --query Parameter.Value --output text > /home/ubuntu/app/secrets/firebase-service-account.json",
            "docker compose -f /home/ubuntu/app/docker-compose.yml pull backend chat",
            "docker compose -f /home/ubuntu/app/docker-compose.yml up -d --no-deps backend chat",
            "sleep 10 && docker compose -f /home/ubuntu/app/docker-compose.yml exec -T nginx nginx -s reload",
            "docker image prune -f"
          ]')

          CMD_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Environment,Values=dev" "Key=tag:Service,Values=app" \
            --parameters "{\"commands\": $COMMANDS}" \
            --timeout-seconds 300 \
            --comment "deploy dev ${{ github.sha }}" \
            --query "Command.CommandId" \
            --output text)

          echo "SSM Command: $CMD_ID"

          for i in $(seq 1 60); do
            sleep 5
            STATUS=$(aws ssm list-command-invocations \
              --command-id "$CMD_ID" \
              --query "CommandInvocations[0].Status" \
              --output text 2>/dev/null || echo "Pending")
            echo "[$i/60] $STATUS"
            case "$STATUS" in
              Success) exit 0 ;;
              Failed|Cancelled|TimedOut|DeliveryTimedOut)
                aws ssm list-command-invocations --command-id "$CMD_ID" --details \
                  --query "CommandInvocations[0].CommandPlugins[0].Output" --output text || true
                exit 1 ;;
              None)
                if [ "$i" -ge 3 ]; then
                  echo "::error::No instance matched SSM target (status=None)"
                  exit 1
                fi ;;
            esac
          done
          echo "::error::SSM command timed out"
          exit 1

      - name: Notify Discord
        if: always()
        run: |
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -1)
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          ACTIONS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "${{ job.status }}" == "success" ]; then
            COLOR=3066993; STATUS_EMOJI="âœ…"; STATUS_TEXT="ë°°í¬ ì„±ê³µ"
          else
            COLOR=15158528; STATUS_EMOJI="âŒ"; STATUS_TEXT="ë°°í¬ ì‹¤íŒ¨"
          fi

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"content\": \"$STATUS_EMOJI **Backend Development ë°°í¬ ì•Œë¦¼**\",
                 \"embeds\": [{
                   \"title\": \"ğŸ”§ [Development] $STATUS_TEXT\",
                   \"color\": $COLOR,
                   \"fields\": [
                     {\"name\": \"ğŸ“¦ ì €ì¥ì†Œ\", \"value\": \"\`${{ github.repository }}\`\", \"inline\": true},
                     {\"name\": \"ğŸŒ¿ ë¸Œëœì¹˜\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true},
                     {\"name\": \"ğŸ”– ì»¤ë°‹\", \"value\": \"[\`$SHORT_SHA\`]($COMMIT_URL)\", \"inline\": true},
                     {\"name\": \"ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€\", \"value\": \"$COMMIT_MSG\", \"inline\": false},
                     {\"name\": \"ğŸ‘¤ ì‘ì„±ì\", \"value\": \"$COMMIT_AUTHOR\", \"inline\": true},
                     {\"name\": \"ğŸ“‹ ìƒì„¸ ë¡œê·¸\", \"value\": \"[Actionsì—ì„œ í™•ì¸]($ACTIONS_URL)\", \"inline\": true}
                   ],
                   \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
                 }]
               }" \
               ${{ secrets.DISCORD_WEBHOOK_URL }} || true

  # â”€â”€â”€ Prod Blue/Green ë°°í¬: API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-prod-api:
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      color: ${{ steps.deploy.outputs.color }}
      port: ${{ steps.deploy.outputs.port }}
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ap-northeast-2

      - name: Blue/Green Deploy API
        id: deploy
        run: |
          REGISTRY="${{ secrets.ECR_REGISTRY }}"
          TAG="${{ needs.build-and-push.outputs.image-tag }}"
          SERVICE="api"
          BLUE_PORT=8080; GREEN_PORT=8082; INTERNAL_PORT=8080
          HEALTH_PATH="/api/actuator/health"

          wait_ssm() {
            local cmd_id=$1 label=$2 max=${3:-60}
            for i in $(seq 1 "$max"); do
              sleep 5
              STATUS=$(aws ssm list-command-invocations \
                --command-id "$cmd_id" \
                --query "CommandInvocations[0].Status" \
                --output text 2>/dev/null || echo "Pending")
              echo "[$label $i/$max] $STATUS"
              case "$STATUS" in
                Success) return 0 ;;
                Failed|Cancelled|TimedOut|DeliveryTimedOut)
                  echo "::error::${label} failed: ${STATUS}"
                  aws ssm list-command-invocations --command-id "$cmd_id" --details \
                    --query "CommandInvocations[0].CommandPlugins[0].Output" --output text || true
                  return 1 ;;
                None)
                  if [ "$i" -ge 3 ]; then
                    echo "::error::${label}: no instance matched SSM target (status=None)"
                    return 1
                  fi ;;
              esac
            done
            echo "::error::${label} timed out"; return 1
          }

          # 1) Discover â€” í˜„ì¬ í™œì„± ì»¨í…Œì´ë„ˆ/ìƒ‰ìƒ í™•ì¸
          DISCOVER_CMDS=$(jq -n '[
            "if docker ps --format \"{{.Names}}\" | grep -qE \"doktori-api-blue\"; then echo \"ACTIVE=blue\";",
            "elif docker ps --format \"{{.Names}}\" | grep -qE \"doktori-api-green\"; then echo \"ACTIVE=green\";",
            "elif docker ps --format \"{{.Names}}\" | grep -qE \"(backend-api|doktori-api)$\"; then echo \"ACTIVE=legacy\";",
            "else echo \"ACTIVE=none\"; fi"
          ]')
          DISCOVER_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Name,Values=doktori-prod-api" \
            --parameters "{\"commands\": $DISCOVER_CMDS}" \
            --timeout-seconds 30 \
            --comment "discover api color" \
            --query "Command.CommandId" --output text)
          wait_ssm "$DISCOVER_ID" "discover" 12

          DISCOVER_OUT=$(aws ssm list-command-invocations --command-id "$DISCOVER_ID" --details \
            --query "CommandInvocations[0].CommandPlugins[0].Output" --output text)
          ACTIVE_COLOR=$(echo "$DISCOVER_OUT" | grep -oP 'ACTIVE=\K\w+' || echo "none")
          echo "Active color: $ACTIVE_COLOR"

          # ìƒ‰ìƒ/í¬íŠ¸ ê²°ì •
          case "$ACTIVE_COLOR" in
            blue)   NEW_COLOR=green; NEW_PORT=$GREEN_PORT; OLD_COLOR=blue; OLD_PORT=$BLUE_PORT ;;
            green)  NEW_COLOR=blue;  NEW_PORT=$BLUE_PORT;  OLD_COLOR=green; OLD_PORT=$GREEN_PORT ;;
            legacy) NEW_COLOR=green; NEW_PORT=$GREEN_PORT; OLD_COLOR=legacy; OLD_PORT=$BLUE_PORT ;;
            none)   NEW_COLOR=blue;  NEW_PORT=$BLUE_PORT;  OLD_COLOR=none;  OLD_PORT=0 ;;
          esac
          echo "Deploying: $NEW_COLOR (port $NEW_PORT)"
          echo "color=${NEW_COLOR}" >> $GITHUB_OUTPUT
          echo "port=${NEW_PORT}" >> $GITHUB_OUTPUT

          # 2) Deploy â€” ìƒˆ ì»¨í…Œì´ë„ˆ ê¸°ë™
          DEPLOY_CMDS=$(jq -n --arg r "$REGISTRY" --arg t "$TAG" \
            --arg name "doktori-api-${NEW_COLOR}" \
            --arg np "$NEW_PORT" --arg ip "$INTERNAL_PORT" '[
            "set -e",
            ("aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin " + $r),
            ("docker pull " + $r + "/doktori/backend-api:" + $t),
            "mkdir -p /home/ubuntu/app/secrets",
            "aws ssm get-parameter --name /doktori/prod/FIREBASE_SERVICE_ACCOUNT --with-decryption --query Parameter.Value --output text > /home/ubuntu/app/secrets/firebase-service-account.json",
            ("docker stop " + $name + " 2>/dev/null || true"),
            ("docker rm " + $name + " 2>/dev/null || true"),
            ("docker run -d --name " + $name + " --restart unless-stopped -e SPRING_PROFILES_ACTIVE=prod -e FIREBASE_CREDENTIALS_PATH=file:/app/secrets/firebase-service-account.json -v /home/ubuntu/app/secrets/firebase-service-account.json:/app/secrets/firebase-service-account.json:ro -p " + $np + ":" + $ip + " " + $r + "/doktori/backend-api:" + $t)
          ]')
          DEPLOY_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Name,Values=doktori-prod-api" \
            --parameters "{\"commands\": $DEPLOY_CMDS}" \
            --timeout-seconds 300 \
            --comment "deploy api ${NEW_COLOR} ${{ github.sha }}" \
            --query "Command.CommandId" --output text)
          wait_ssm "$DEPLOY_ID" "deploy-api" 60

          # 3) Health check â€” ìƒˆ ì»¨í…Œì´ë„ˆ readiness í™•ì¸
          HEALTH_CMDS=$(jq -n --arg np "$NEW_PORT" --arg hp "$HEALTH_PATH" '[
            "for i in $(seq 1 12); do",
            ("  if curl -sf http://localhost:" + $np + $hp + " > /dev/null 2>&1; then echo \"HEALTHY\"; exit 0; fi"),
            "  echo \"Waiting... ($i/12)\"; sleep 5",
            "done",
            "echo \"UNHEALTHY\"; exit 1"
          ]')
          HEALTH_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Name,Values=doktori-prod-api" \
            --parameters "{\"commands\": $HEALTH_CMDS}" \
            --timeout-seconds 120 \
            --comment "health check api ${NEW_COLOR}" \
            --query "Command.CommandId" --output text)

          if ! wait_ssm "$HEALTH_ID" "health-api" 30; then
            echo "::error::Health check failed â€” rolling back"
            ROLLBACK_CMDS=$(jq -n --arg name "doktori-api-${NEW_COLOR}" '[
              ("docker stop " + $name + " 2>/dev/null || true"),
              ("docker rm " + $name + " 2>/dev/null || true")
            ]')
            RB_ID=$(aws ssm send-command \
              --document-name "AWS-RunShellScript" \
              --targets "Key=tag:Name,Values=doktori-prod-api" \
              --parameters "{\"commands\": $ROLLBACK_CMDS}" \
              --timeout-seconds 60 \
              --comment "rollback api" \
              --query "Command.CommandId" --output text)
            wait_ssm "$RB_ID" "rollback-api" 12 || true
            exit 1
          fi

          # 4) Nginx switch â€” upstream í¬íŠ¸ ì „í™˜ + ìƒíƒœ íŒŒì¼ ê¸°ë¡
          # ìƒíƒœ íŒŒì¼: ì»¨í…Œì´ë„ˆ ë‚´ë¶€(/etc/nginx/state/) + í˜¸ìŠ¤íŠ¸(/opt/nginx-state/) ì´ì¤‘ ê¸°ë¡
          # - docker restart: ì»¨í…Œì´ë„ˆ ë‚´ë¶€ íŒŒì¼ ìœ ì§€
          # - docker rm + run: í˜¸ìŠ¤íŠ¸ ë³¼ë¥¨ ë§ˆìš´íŠ¸(-v /opt/nginx-state:/etc/nginx/state) í•„ìš”
          SWITCH_CMDS=$(jq -n --arg np "$NEW_PORT" '[
            "set -e",
            ("docker exec doktori-nginx sed -i -E \"s/:[0-9]+;/:" + $np + ";/\" /etc/nginx/conf.d/upstream-api.conf"),
            "docker exec doktori-nginx nginx -t",
            "docker exec doktori-nginx nginx -s reload",
            ("docker exec doktori-nginx sh -c \"mkdir -p /etc/nginx/state && echo " + $np + " > /etc/nginx/state/active-port-api\""),
            "mkdir -p /opt/nginx-state",
            ("echo " + $np + " > /opt/nginx-state/active-port-api")
          ]')
          SWITCH_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Name,Values=doktori-prod-nginx" \
            --parameters "{\"commands\": $SWITCH_CMDS}" \
            --timeout-seconds 60 \
            --comment "nginx switch api to ${NEW_COLOR}" \
            --query "Command.CommandId" --output text)
          wait_ssm "$SWITCH_ID" "nginx-switch-api" 12

          # 5) Stop old â€” ì´ì „ ì»¨í…Œì´ë„ˆ ì •ì§€
          if [ "$OLD_COLOR" != "none" ]; then
            if [ "$OLD_COLOR" = "legacy" ]; then
              OLD_NAMES="backend-api doktori-api"
            else
              OLD_NAMES="doktori-api-${OLD_COLOR}"
            fi
            STOP_CMDS=$(jq -n --arg names "$OLD_NAMES" '[
              ("for c in " + $names + "; do docker stop $c 2>/dev/null || true; docker rm $c 2>/dev/null || true; done"),
              "docker image prune -f"
            ]')
            STOP_ID=$(aws ssm send-command \
              --document-name "AWS-RunShellScript" \
              --targets "Key=tag:Name,Values=doktori-prod-api" \
              --parameters "{\"commands\": $STOP_CMDS}" \
              --timeout-seconds 60 \
              --comment "stop old api ${OLD_COLOR}" \
              --query "Command.CommandId" --output text)
            wait_ssm "$STOP_ID" "stop-old-api" 12 || true
          fi

          echo "API deployed: ${NEW_COLOR} on port ${NEW_PORT}"

  # â”€â”€â”€ Prod Blue/Green ë°°í¬: Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-prod-chat:
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      color: ${{ steps.deploy.outputs.color }}
      port: ${{ steps.deploy.outputs.port }}
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ap-northeast-2

      - name: Blue/Green Deploy Chat
        id: deploy
        run: |
          REGISTRY="${{ secrets.ECR_REGISTRY }}"
          TAG="${{ needs.build-and-push.outputs.image-tag }}"
          SERVICE="chat"
          BLUE_PORT=8081; GREEN_PORT=8083; INTERNAL_PORT=8081
          HEALTH_PATH="/api/chat/actuator/health"

          wait_ssm() {
            local cmd_id=$1 label=$2 max=${3:-60}
            for i in $(seq 1 "$max"); do
              sleep 5
              STATUS=$(aws ssm list-command-invocations \
                --command-id "$cmd_id" \
                --query "CommandInvocations[0].Status" \
                --output text 2>/dev/null || echo "Pending")
              echo "[$label $i/$max] $STATUS"
              case "$STATUS" in
                Success) return 0 ;;
                Failed|Cancelled|TimedOut|DeliveryTimedOut)
                  echo "::error::${label} failed: ${STATUS}"
                  aws ssm list-command-invocations --command-id "$cmd_id" --details \
                    --query "CommandInvocations[0].CommandPlugins[0].Output" --output text || true
                  return 1 ;;
                None)
                  if [ "$i" -ge 3 ]; then
                    echo "::error::${label}: no instance matched SSM target (status=None)"
                    return 1
                  fi ;;
              esac
            done
            echo "::error::${label} timed out"; return 1
          }

          # 1) Discover
          DISCOVER_CMDS=$(jq -n '[
            "if docker ps --format \"{{.Names}}\" | grep -qE \"doktori-chat-blue\"; then echo \"ACTIVE=blue\";",
            "elif docker ps --format \"{{.Names}}\" | grep -qE \"doktori-chat-green\"; then echo \"ACTIVE=green\";",
            "elif docker ps --format \"{{.Names}}\" | grep -qE \"(backend-chat|doktori-chat)$\"; then echo \"ACTIVE=legacy\";",
            "else echo \"ACTIVE=none\"; fi"
          ]')
          DISCOVER_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Name,Values=doktori-prod-chat" \
            --parameters "{\"commands\": $DISCOVER_CMDS}" \
            --timeout-seconds 30 \
            --comment "discover chat color" \
            --query "Command.CommandId" --output text)
          wait_ssm "$DISCOVER_ID" "discover" 12

          DISCOVER_OUT=$(aws ssm list-command-invocations --command-id "$DISCOVER_ID" --details \
            --query "CommandInvocations[0].CommandPlugins[0].Output" --output text)
          ACTIVE_COLOR=$(echo "$DISCOVER_OUT" | grep -oP 'ACTIVE=\K\w+' || echo "none")
          echo "Active color: $ACTIVE_COLOR"

          case "$ACTIVE_COLOR" in
            blue)   NEW_COLOR=green; NEW_PORT=$GREEN_PORT; OLD_COLOR=blue; OLD_PORT=$BLUE_PORT ;;
            green)  NEW_COLOR=blue;  NEW_PORT=$BLUE_PORT;  OLD_COLOR=green; OLD_PORT=$GREEN_PORT ;;
            legacy) NEW_COLOR=green; NEW_PORT=$GREEN_PORT; OLD_COLOR=legacy; OLD_PORT=$BLUE_PORT ;;
            none)   NEW_COLOR=blue;  NEW_PORT=$BLUE_PORT;  OLD_COLOR=none;  OLD_PORT=0 ;;
          esac
          echo "Deploying: $NEW_COLOR (port $NEW_PORT)"
          echo "color=${NEW_COLOR}" >> $GITHUB_OUTPUT
          echo "port=${NEW_PORT}" >> $GITHUB_OUTPUT

          # 2) Deploy
          # TODO: Chat 30ë¶„ í† ë¡  ì„¸ì…˜ graceful drain â€” ë°±ì—”ë“œ ë…¼ì˜ í›„ ì¶”ê°€
          DEPLOY_CMDS=$(jq -n --arg r "$REGISTRY" --arg t "$TAG" \
            --arg name "doktori-chat-${NEW_COLOR}" \
            --arg np "$NEW_PORT" --arg ip "$INTERNAL_PORT" '[
            "set -e",
            ("aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin " + $r),
            ("docker pull " + $r + "/doktori/backend-chat:" + $t),
            "mkdir -p /home/ubuntu/app/secrets",
            "aws ssm get-parameter --name /doktori/prod/FIREBASE_SERVICE_ACCOUNT --with-decryption --query Parameter.Value --output text > /home/ubuntu/app/secrets/firebase-service-account.json",
            ("docker stop " + $name + " 2>/dev/null || true"),
            ("docker rm " + $name + " 2>/dev/null || true"),
            ("docker run -d --name " + $name + " --restart unless-stopped -e SPRING_PROFILES_ACTIVE=prod -e FIREBASE_CREDENTIALS_PATH=file:/app/secrets/firebase-service-account.json -v /home/ubuntu/app/secrets/firebase-service-account.json:/app/secrets/firebase-service-account.json:ro -p " + $np + ":" + $ip + " " + $r + "/doktori/backend-chat:" + $t)
          ]')
          DEPLOY_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Name,Values=doktori-prod-chat" \
            --parameters "{\"commands\": $DEPLOY_CMDS}" \
            --timeout-seconds 300 \
            --comment "deploy chat ${NEW_COLOR} ${{ github.sha }}" \
            --query "Command.CommandId" --output text)
          wait_ssm "$DEPLOY_ID" "deploy-chat" 60

          # 3) Health check
          HEALTH_CMDS=$(jq -n --arg np "$NEW_PORT" --arg hp "$HEALTH_PATH" '[
            "for i in $(seq 1 12); do",
            ("  if curl -sf http://localhost:" + $np + $hp + " > /dev/null 2>&1; then echo \"HEALTHY\"; exit 0; fi"),
            "  echo \"Waiting... ($i/12)\"; sleep 5",
            "done",
            "echo \"UNHEALTHY\"; exit 1"
          ]')
          HEALTH_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Name,Values=doktori-prod-chat" \
            --parameters "{\"commands\": $HEALTH_CMDS}" \
            --timeout-seconds 120 \
            --comment "health check chat ${NEW_COLOR}" \
            --query "Command.CommandId" --output text)

          if ! wait_ssm "$HEALTH_ID" "health-chat" 30; then
            echo "::error::Health check failed â€” rolling back"
            ROLLBACK_CMDS=$(jq -n --arg name "doktori-chat-${NEW_COLOR}" '[
              ("docker stop " + $name + " 2>/dev/null || true"),
              ("docker rm " + $name + " 2>/dev/null || true")
            ]')
            RB_ID=$(aws ssm send-command \
              --document-name "AWS-RunShellScript" \
              --targets "Key=tag:Name,Values=doktori-prod-chat" \
              --parameters "{\"commands\": $ROLLBACK_CMDS}" \
              --timeout-seconds 60 \
              --comment "rollback chat" \
              --query "Command.CommandId" --output text)
            wait_ssm "$RB_ID" "rollback-chat" 12 || true
            exit 1
          fi

          # 4) Nginx switch
          SWITCH_CMDS=$(jq -n --arg np "$NEW_PORT" '[
            "set -e",
            ("docker exec doktori-nginx sed -i -E \"s/:[0-9]+;/:" + $np + ";/\" /etc/nginx/conf.d/upstream-chat.conf"),
            "docker exec doktori-nginx nginx -t",
            "docker exec doktori-nginx nginx -s reload",
            ("docker exec doktori-nginx sh -c \"mkdir -p /etc/nginx/state && echo " + $np + " > /etc/nginx/state/active-port-chat\""),
            "mkdir -p /opt/nginx-state",
            ("echo " + $np + " > /opt/nginx-state/active-port-chat")
          ]')
          SWITCH_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Name,Values=doktori-prod-nginx" \
            --parameters "{\"commands\": $SWITCH_CMDS}" \
            --timeout-seconds 60 \
            --comment "nginx switch chat to ${NEW_COLOR}" \
            --query "Command.CommandId" --output text)
          wait_ssm "$SWITCH_ID" "nginx-switch-chat" 12

          # 5) Stop old
          if [ "$OLD_COLOR" != "none" ]; then
            if [ "$OLD_COLOR" = "legacy" ]; then
              OLD_NAMES="backend-chat doktori-chat"
            else
              OLD_NAMES="doktori-chat-${OLD_COLOR}"
            fi
            STOP_CMDS=$(jq -n --arg names "$OLD_NAMES" '[
              ("for c in " + $names + "; do docker stop $c 2>/dev/null || true; docker rm $c 2>/dev/null || true; done"),
              "docker image prune -f"
            ]')
            STOP_ID=$(aws ssm send-command \
              --document-name "AWS-RunShellScript" \
              --targets "Key=tag:Name,Values=doktori-prod-chat" \
              --parameters "{\"commands\": $STOP_CMDS}" \
              --timeout-seconds 60 \
              --comment "stop old chat ${OLD_COLOR}" \
              --query "Command.CommandId" --output text)
            wait_ssm "$STOP_ID" "stop-old-chat" 12 || true
          fi

          echo "Chat deployed: ${NEW_COLOR} on port ${NEW_PORT}"

  # â”€â”€â”€ Prod ë°°í¬ ì•Œë¦¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify-prod:
    needs: [build-and-push, deploy-prod-api, deploy-prod-chat]
    if: always() && github.ref == 'refs/heads/main' && needs.build-and-push.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Notify Discord
        run: |
          SHORT_SHA="${GITHUB_SHA:0:7}"
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -1)
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          ACTIONS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          API_RESULT="${{ needs.deploy-prod-api.result }}"
          CHAT_RESULT="${{ needs.deploy-prod-chat.result }}"
          API_COLOR="${{ needs.deploy-prod-api.outputs.color }}"
          API_PORT="${{ needs.deploy-prod-api.outputs.port }}"
          CHAT_COLOR="${{ needs.deploy-prod-chat.outputs.color }}"
          CHAT_PORT="${{ needs.deploy-prod-chat.outputs.port }}"

          if [ "$API_RESULT" == "success" ] && [ "$CHAT_RESULT" == "success" ]; then
            COLOR=3066993; STATUS_EMOJI="âœ…"; STATUS_TEXT="ë°°í¬ ì„±ê³µ"
          else
            COLOR=15158528; STATUS_EMOJI="âŒ"; STATUS_TEXT="ë°°í¬ ì‹¤íŒ¨ (API:${API_RESULT} Chat:${CHAT_RESULT})"
          fi

          curl -sS -H "Content-Type: application/json" -X POST -d "{
            \"content\": \"${STATUS_EMOJI} **Backend Production ë°°í¬ ì•Œë¦¼**\",
            \"embeds\": [{
              \"title\": \"ğŸš€ [Production] ${STATUS_TEXT}\",
              \"color\": ${COLOR},
              \"fields\": [
                {\"name\": \"ğŸ“¦ ì €ì¥ì†Œ\", \"value\": \"\`${{ github.repository }}\`\", \"inline\": true},
                {\"name\": \"ğŸŒ¿ ë¸Œëœì¹˜\", \"value\": \"\`main\`\", \"inline\": true},
                {\"name\": \"ğŸ”– ì»¤ë°‹\", \"value\": \"[\`${SHORT_SHA}\`](${COMMIT_URL})\", \"inline\": true},
                {\"name\": \"ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€\", \"value\": \"${COMMIT_MSG}\", \"inline\": false},
                {\"name\": \"ğŸ”µ API\", \"value\": \"${API_COLOR:-N/A} (port ${API_PORT:-N/A})\", \"inline\": true},
                {\"name\": \"ğŸŸ¢ Chat\", \"value\": \"${CHAT_COLOR:-N/A} (port ${CHAT_PORT:-N/A})\", \"inline\": true},
                {\"name\": \"ğŸ‘¤ ì‘ì„±ì\", \"value\": \"${COMMIT_AUTHOR}\", \"inline\": true},
                {\"name\": \"ğŸ“‹ ìƒì„¸ ë¡œê·¸\", \"value\": \"[Actionsì—ì„œ í™•ì¸](${ACTIONS_URL})\", \"inline\": true}
              ],
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
            }]
          }" ${{ secrets.DISCORD_WEBHOOK_URL }} || true
