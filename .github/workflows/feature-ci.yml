name: Backend Feature CI (Fast)

on:
  push:
    branches:
      - 'feature/**'
    paths:
      - 'api/**'
      - 'chat/**'
      - 'common/**'
      - 'build.gradle'
      - 'settings.gradle'
      - '.github/workflows/feature-ci.yml'

# ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
concurrency:
  group: backend-feature-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quick-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Build & Checkstyle
        run: |
          chmod +x ./gradlew
          ./gradlew checkstyleMain checkstyleTest build -x test --no-daemon --build-cache --scan

      # Notification
      - name: Notify Discord on failure
        if: failure()
        run: |
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -1)
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          ACTIONS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"content\": \"âŒ **Backend Feature CI ì‹¤íŒ¨**\",
                 \"embeds\": [{
                   \"title\": \"ğŸ”´ Feature ë¸Œëœì¹˜ ë¹Œë“œ ì‹¤íŒ¨\",
                   \"color\": 15158528,
                   \"url\": \"$ACTIONS_URL\",
                   \"fields\": [
                     {\"name\": \"ğŸ“¦ ì €ì¥ì†Œ\", \"value\": \"\`${{ github.repository }}\`\", \"inline\": true},
                     {\"name\": \"ğŸŒ¿ ë¸Œëœì¹˜\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true},
                     {\"name\": \"ğŸ”– ì»¤ë°‹\", \"value\": \"[\`$SHORT_SHA\`]($COMMIT_URL)\", \"inline\": true},
                     {\"name\": \"ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€\", \"value\": \"$COMMIT_MSG\", \"inline\": false},
                     {\"name\": \"ğŸ‘¤ ì‘ì„±ì\", \"value\": \"$COMMIT_AUTHOR\", \"inline\": true},
                     {\"name\": \"ğŸ“‹ ìƒì„¸ ë¡œê·¸\", \"value\": \"[Actionsì—ì„œ í™•ì¸]($ACTIONS_URL)\", \"inline\": true}
                   ],
                   \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
                 }]
               }" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}
